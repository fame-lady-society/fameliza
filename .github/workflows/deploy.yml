name: Deploy to Linode

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LINODE_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo -e "Host linode\n  HostName ${{ secrets.LINODE_HOST }}\n  User ${{ secrets.LINODE_USER }}\n  IdentityFile ~/.ssh/deploy_key\n  StrictHostKeyChecking no\n  UserKnownHostsFile /dev/null" > ~/.ssh/config
          chmod 600 ~/.ssh/config

      - name: Deploy to Linode
        run: |
          ssh linode bash -s << 'ENDSSH'
            set -e

            APP_DIR="/opt/fameliza"
            REPO_URL="https://github.com/fame-lady-society/fameliza.git"

            echo "==> Setting up application directory..."
            mkdir -p "$APP_DIR"

            # Bootstrap: clone repo if not present
            if [ ! -d "$APP_DIR/.git" ]; then
              echo "==> First deploy - cloning repository..."
              git clone -b main "$REPO_URL" "$APP_DIR"
            fi

            cd "$APP_DIR"

            echo "==> Pulling latest code..."
            git fetch origin
            git reset --hard origin/main

            echo "==> Rebuilding and restarting services..."
            docker compose -f infrastructure/docker-compose.prod.yml down || true
            docker compose -f infrastructure/docker-compose.prod.yml up -d --build

            echo "==> Waiting for services to start..."
            sleep 10

            echo "==> Service status:"
            docker compose -f infrastructure/docker-compose.prod.yml ps

            echo "==> Deployment complete!"
          ENDSSH

      - name: Health Check
        run: |
          echo "Waiting for services to stabilize..."
          sleep 15
          for i in 1 2 3; do
            response=$(curl -s -o /dev/null -w "%{http_code}" https://ai.fame.support/health || echo "000")
            if [ "$response" = "200" ]; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $i: got status $response, retrying in 10s..."
            sleep 10
          done
          echo "Health check failed after 3 attempts"
          exit 1

